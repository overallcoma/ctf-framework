FROM php:apache

ARG var_flagpage
ARG var_password

RUN mkdir -p /app/
RUN mkdir -p /db/

COPY errorpage.html /app/errorpage.html
COPY flagpage.html /app/${var_flagpage}
COPY htaccess /app/.htaccess
COPY index.php /app/index.php
COPY passhashgen.php /app/passhashgen.php
COPY dbsetup.sql /db/dbsetup.sql

RUN apt update -y
RUN apt install sqlite3 -y

# This should leave file /app/hash.txt - delete that later
RUN php /app/passhashgen.php var_password
#dbsetup.sql should be present after the setup script generates it
COPY dbsetup.sql /db/dbsetup.sql

RUN touch /db/password.db
RUN chown www-data:www-data /db/password.db
RUN sqlite3 /db/dbsetup.sql /db/dbsetup.sql

#Add delete commands after testing

EXPOSE 80